pipeline {
    agent any

    environment {
        ORACLE_HOME = 'F:\\Oracle21c'  // Update with your Oracle client path
        PATH = "${env.ORACLE_HOME}\\bin;${env.PATH}"
    }

    stages {
        stage('Deploy SQL to Oracle') {
            steps {
                script {
                    def oracleHost = '5.tcp.eu.ngrok.io'  // Updated ngrok URL
                    def oraclePort = '10995'  // Updated ngrok port
                    def oracleServiceName = 'ORCL'
                    def oracleUsername = 'SYS'
                    def oraclePassword = 'Oracle21c'
                    def scriptPath = 'F:\\PROJET SGBDA\\SGBD\\SGBD_sql.sql'  // Updated path to SQL file

                    // Construct SQL*Plus command with direct connection method and username/password
                    def sqlplusCmd = "sqlplus -S ${oracleUsername}/${oraclePassword}@//${oracleHost}:${oraclePort}/${oracleServiceName} @${scriptPath}"

                    // Execute SQL*Plus command and capture output
                    def sqlplusOutput = bat(script: sqlplusCmd, returnStdout: true).trim()

                    // Check if SQL*Plus output contains error messages
                    if (sqlplusOutput.contains('ORA-')) {
                        echo "SQL*Plus command failed with the following output:"
                        echo sqlplusOutput
                        currentBuild.result = 'FAILURE'  // Set build result to FAILURE
                    } else {
                        echo "SQL script executed successfully."
                    }
                }
            }
        }
    }

    post {
        always {
            echo "Pipeline completed"
        }
    }
}
