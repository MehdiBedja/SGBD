pipeline {
    agent any
    
    environment {
        // Define environment variables for Render credentials and database details
        RENDER_EMAIL = credentials('km_bedja@esi.dz')
        RENDER_PASSWORD = credentials('crafterdz2003')
        DATABASE_HOSTNAME = 'dpg-cp2jb6fsc6pc73a6qem0-a'
        DATABASE_PORT = 5432
        DATABASE_NAME = 'eventdatabase_gq69'
        DATABASE_USERNAME = 'eventdatabase_gq69_user'
        DATABASE_PASSWORD = credentials('database-password')
    }
    
    stages {
        stage('Setup') {
            steps {
                script {
                    // Login to Render
                    sh "render login --email ${RENDER_EMAIL} --password ${RENDER_PASSWORD}"
                }
            }
        }
        
        stage('Deploy Database') {
            steps {
                script {
                    // Deploy your PostgreSQL database on Render
                    sh "render up database --database-url postgres://${DATABASE_USERNAME}:${DATABASE_PASSWORD}@${DATABASE_HOSTNAME}:${DATABASE_PORT}/${DATABASE_NAME}"
                }
            }
        }
        
        stage('Run Tests') {
            steps {
                script {
                    // Run your database tests
                    sh 'your-test-command'
                }
            }
        }
        
        stage('Cleanup') {
            steps {
                script {
                    // Delete the database after tests
                    sh "render down database --database-url postgres://${DATABASE_USERNAME}:${DATABASE_PASSWORD}@${DATABASE_HOSTNAME}:${DATABASE_PORT}/${DATABASE_NAME}"
                }
            }
        }
    }
    
    post {
        always {
            // Logout from Render
            sh 'render logout'
        }
    }
}
