pipeline {
    agent any
    
    environment {
        // Define environment variables for Render credentials and database details
        RENDER_EMAIL = credentials('km_bedja@esi.dz')
        RENDER_PASSWORD = credentials('crafterdz2003')
        DATABASE_HOSTNAME = 'dpg-cp2jb6fsc6pc73a6qem0-a'
        DATABASE_PORT = 5432
        DATABASE_NAME = 'eventdatabase_gq69'
        DATABASE_USERNAME = 'eventdatabase_gq69_user'
        DATABASE_PASSWORD = credentials('database-password')
    }
    
    stages {
        stage('Setup') {
            steps {
                script {
                    // Login to Render
                    bat "render login --email ${RENDER_EMAIL} --password ${RENDER_PASSWORD}"
                }
            }
        }
        
        stage('Deploy Database') {
            steps {
                script {
                    // Deploy your PostgreSQL database on Render
                    bat "render up database --database-url postgres://${DATABASE_USERNAME}:${DATABASE_PASSWORD}@${DATABASE_HOSTNAME}:${DATABASE_PORT}/${DATABASE_NAME}"
                }
            }
        }
        
        stage('Run Tests') {
            steps {
                script {
                    // Run your database tests
                    bat 'your-test-command'
                }
            }
        }
    }
    
    post {
        success {
            // Only perform cleanup if the pipeline is successful
            script {
                // Delete the database after tests
                bat "render down database --database-url postgres://${DATABASE_USERNAME}:${DATABASE_PASSWORD}@${DATABASE_HOSTNAME}:${DATABASE_PORT}/${DATABASE_NAME}"
                
                // Logout from Render
                bat 'render logout'
            }
        }
        failure {
            // Perform cleanup and logout even if the pipeline fails
            script {
                // Delete the database after tests
                bat "render down database --database-url postgres://${DATABASE_USERNAME}:${DATABASE_PASSWORD}@${DATABASE_HOSTNAME}:${DATABASE_PORT}/${DATABASE_NAME}"
                
                // Logout from Render
                bat 'render logout'
            }
        }
    }
}
